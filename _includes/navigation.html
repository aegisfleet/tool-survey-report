<nav class="main-navigation" role="navigation" aria-label="メインナビゲーション">
  <button class="nav-toggle" aria-controls="nav-menu" aria-expanded="false">
    <span class="screen-reader-text">メニューを開く</span>
    <span class="nav-toggle-icon">
      <span></span>
      <span></span>
      <span></span>
    </span>
  </button>
  
  <div class="nav-search">
    <form class="search-form" role="search" aria-label="サイト内検索">
      <input type="text" id="nav-search-input" class="search-input" placeholder="レポートを検索..." aria-label="検索キーワード">
      <button type="submit" class="search-button" aria-label="検索実行">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
        </svg>
      </button>
    </form>
  </div>
  
  <ul class="nav-menu" id="nav-menu">
    <li class="nav-item">
      <a href="{{ '/' | relative_url }}" class="nav-link {% if page.url == '/' %}current{% endif %}">
        ホーム
      </a>
    </li>
    
    <li class="nav-item">
      <a href="{{ '/reports/' | relative_url }}" class="nav-link {% if page.url contains '/reports/' %}current{% endif %}">
        すべてのレポート
      </a>
    </li>
    
    <li class="nav-item">
      <a href="{{ '/tags/' | relative_url }}" class="nav-link {% if page.url contains '/tags/' %}current{% endif %}">
        タグ一覧
      </a>
    </li>
    
    <li class="nav-item dropdown">
      <a href="#" class="nav-link dropdown-toggle" aria-haspopup="true" aria-expanded="false">
        カテゴリー
      </a>
      <ul class="dropdown-menu">
        {% assign tags = site.reports | map: 'tags' | join: ',' | split: ',' | uniq | sort %}
        {% for tag in tags %}
          {% if tag != '' %}
            {% assign tag_count = site.reports | where_exp: "report", "report.tags contains tag" | size %}
            <li>
              <a href="{{ '/reports/' | relative_url }}?tag={{ tag | url_encode }}" class="dropdown-link">
                {{ tag }} <span class="tag-count">({{ tag_count }})</span>
              </a>
            </li>
          {% endif %}
        {% endfor %}
        {% if tags.size == 0 %}
          <li><span class="dropdown-text">カテゴリーがありません</span></li>
        {% else %}
          <li class="dropdown-divider"></li>
          <li>
            <a href="{{ '/tags/' | relative_url }}" class="dropdown-link view-all">
              すべてのタグを見る →
            </a>
          </li>
        {% endif %}
      </ul>
    </li>
    
    {% if site.data.navigation.main_links %}
      {% for link in site.data.navigation.main_links %}
        <li class="nav-item">
          <a href="{{ link.url | relative_url }}" class="nav-link {% if page.url == link.url %}current{% endif %}">
            {{ link.title }}
          </a>
        </li>
      {% endfor %}
    {% endif %}
  </ul>
</nav>

<script>
// Mobile navigation toggle
document.addEventListener('DOMContentLoaded', function() {
  const navToggle = document.querySelector('.nav-toggle');
  const navMenu = document.querySelector('.nav-menu');
  
  if (navToggle && navMenu) {
    navToggle.addEventListener('click', function() {
      const isExpanded = navToggle.getAttribute('aria-expanded') === 'true';
      navToggle.setAttribute('aria-expanded', !isExpanded);
      navMenu.classList.toggle('active');
    });
  }
  
  // Dropdown functionality
  const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
  dropdownToggles.forEach(function(toggle) {
    toggle.addEventListener('click', function(e) {
      e.preventDefault();
      const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
      
      // Close all other dropdowns
      dropdownToggles.forEach(function(otherToggle) {
        if (otherToggle !== toggle) {
          otherToggle.setAttribute('aria-expanded', 'false');
          otherToggle.parentElement.classList.remove('active');
        }
      });
      
      // Toggle current dropdown
      toggle.setAttribute('aria-expanded', !isExpanded);
      toggle.parentElement.classList.toggle('active');
    });
  });
  
  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown')) {
      dropdownToggles.forEach(function(toggle) {
        toggle.setAttribute('aria-expanded', 'false');
        toggle.parentElement.classList.remove('active');
      });
    }
  });
  
  // Navigation search functionality
  const searchForm = document.querySelector('.search-form');
  const searchInput = document.getElementById('nav-search-input');
  
  if (searchForm && searchInput) {
    searchForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const searchTerm = searchInput.value.trim();
      if (searchTerm) {
        // Redirect to reports page with search parameter
        const reportsUrl = '{{ "/reports/" | relative_url }}';
        window.location.href = reportsUrl + '?search=' + encodeURIComponent(searchTerm);
      }
    });
  }
});
</script>