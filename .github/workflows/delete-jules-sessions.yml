name: Delete Jules Sessions

on:
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      delete_all:
        description: 'å…¨ãƒªãƒã‚¸ãƒˆãƒªã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã™ã‚‹'
        required: false
        type: boolean
        default: false
      debug_mode:
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆæœ€åˆã®1ä»¶ã®APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡ºåŠ›ï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  delete-sessions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Delete Jules sessions
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          DELETE_ALL: ${{ inputs.delete_all || 'false' }}
          DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
          TARGET_REPO: ${{ github.repository }}
        run: |
          set -e
          
          TOTAL_DELETED=0
          TOTAL_SKIPPED=0
          PAGE_TOKEN=""
          DEBUG_DONE=false
          
          if [ "$DELETE_ALL" = "true" ]; then
            echo "ğŸ—‘ï¸ å…¨ãƒªãƒã‚¸ãƒˆãƒªã®Julesã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ã‚’é–‹å§‹ã—ã¾ã™..."
          else
            echo "ğŸ—‘ï¸ ãƒªãƒã‚¸ãƒˆãƒª '$TARGET_REPO' ã®Julesã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ã‚’é–‹å§‹ã—ã¾ã™..."
          fi
          
          while true; do
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’å–å¾—
            if [ -z "$PAGE_TOKEN" ]; then
              RESPONSE=$(curl -s -H "x-goog-api-key: $JULES_API_KEY" \
                "https://jules.googleapis.com/v1alpha/sessions?pageSize=100")
            else
              RESPONSE=$(curl -s -H "x-goog-api-key: $JULES_API_KEY" \
                "https://jules.googleapis.com/v1alpha/sessions?pageSize=100&pageToken=$PAGE_TOKEN")
            fi
            
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’JSONã¨ã—ã¦å‡¦ç†
            SESSIONS_JSON=$(echo "$RESPONSE" | jq -c '.sessions[]? // empty' 2>/dev/null || echo "")
            
            if [ -z "$SESSIONS_JSON" ]; then
              echo "âœ… å‰Šé™¤å¯¾è±¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“"
              break
            fi
            
            # å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‡¦ç†
            echo "$SESSIONS_JSON" | while IFS= read -r session; do
              if [ -n "$session" ]; then
                session_name=$(echo "$session" | jq -r '.name')
                
                # ãƒªãƒã‚¸ãƒˆãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆDELETE_ALLãŒfalseã®å ´åˆï¼‰
                if [ "$DELETE_ALL" != "true" ]; then
                  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è©³ç´°ã‚’å–å¾—ã—ã¦ãƒªãƒã‚¸ãƒˆãƒªã‚’ç¢ºèª
                  SESSION_DETAIL=$(curl -s -H "x-goog-api-key: $JULES_API_KEY" \
                    "https://jules.googleapis.com/v1alpha/$session_name")
                  
                  # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: æœ€åˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®JSONæ§‹é€ ã‚’å‡ºåŠ›
                  if [ "$DEBUG_MODE" = "true" ] && [ ! -f /tmp/debug_done.txt ]; then
                    echo "ğŸ” ãƒ‡ãƒãƒƒã‚°: ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ã®JSONæ§‹é€ "
                    echo "$SESSION_DETAIL" | jq '.'
                    echo "---"
                    touch /tmp/debug_done.txt
                  fi
                  
                  # è¤‡æ•°ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ‘ã‚¹ã‚’è©¦è¡Œ
                  SESSION_REPO=""
                  
                  # ãƒ‘ã‚¿ãƒ¼ãƒ³1: .sourceContext.source (ãƒ¡ã‚¤ãƒ³: "sources/github/owner/repo" å½¢å¼)
                  if [ -z "$SESSION_REPO" ] || [ "$SESSION_REPO" = "/" ] || [ "$SESSION_REPO" = "null" ] || [ "$SESSION_REPO" = "" ]; then
                    SOURCE_PATH=$(echo "$SESSION_DETAIL" | jq -r '.sourceContext.source // ""' 2>/dev/null || echo "")
                    if [ -n "$SOURCE_PATH" ]; then
                      # "sources/github/owner/repo" ã‹ã‚‰ "owner/repo" ã‚’æŠ½å‡º
                      SESSION_REPO=$(echo "$SOURCE_PATH" | sed 's|^sources/github/||')
                    fi
                  fi
                  
                  # ãƒ‘ã‚¿ãƒ¼ãƒ³2: .source.gitHubRepository (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
                  if [ -z "$SESSION_REPO" ] || [ "$SESSION_REPO" = "/" ] || [ "$SESSION_REPO" = "null" ]; then
                    SESSION_REPO=$(echo "$SESSION_DETAIL" | jq -r '(.source.gitHubRepository.owner // "") + "/" + (.source.gitHubRepository.name // "")' 2>/dev/null || echo "")
                  fi
                  
                  if [ "$SESSION_REPO" != "$TARGET_REPO" ]; then
                    echo "  ã‚¹ã‚­ãƒƒãƒ—: $session_name (ãƒªãƒã‚¸ãƒˆãƒª: $SESSION_REPO)"
                    continue
                  fi
                  
                  # å®Ÿè¡Œä¸­ãƒ»å¾…æ©Ÿä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å‰Šé™¤ã—ãªã„ï¼ˆCOMPLETED/FAILEDã®ã¿å‰Šé™¤å¯¾è±¡ï¼‰
                  # å…¬å¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: QUEUED, PLANNING, AWAITING_PLAN_APPROVAL, AWAITING_USER_FEEDBACK,
                  #                 IN_PROGRESS, PAUSED, FAILED, COMPLETED, STATE_UNSPECIFIED
                  SESSION_STATE=$(echo "$SESSION_DETAIL" | jq -r '.state // ""' 2>/dev/null || echo "")
                  if [ "$SESSION_STATE" != "COMPLETED" ] && [ "$SESSION_STATE" != "FAILED" ]; then
                    echo "  ã‚¹ã‚­ãƒƒãƒ—: $session_name (çŠ¶æ…‹: $SESSION_STATE)"
                    continue
                  fi
                fi
                
                echo "  å‰Šé™¤ä¸­: $session_name"
                DELETE_RESPONSE=$(curl -s -X DELETE \
                  -H "x-goog-api-key: $JULES_API_KEY" \
                  "https://jules.googleapis.com/v1alpha/$session_name" \
                  -w "\n%{http_code}")
                
                HTTP_CODE=$(echo "$DELETE_RESPONSE" | tail -n1)
                
                if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
                  echo "DELETED" >> /tmp/deleted_count.txt
                else
                  echo "  âš ï¸ å‰Šé™¤å¤±æ•— (HTTP $HTTP_CODE): $session_name"
                fi
                
                # ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
                sleep 0.5
              fi
            done
            
            # æ¬¡ã®ãƒšãƒ¼ã‚¸ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
            PAGE_TOKEN=$(echo "$RESPONSE" | jq -r '.nextPageToken // empty' 2>/dev/null || echo "")
            
            if [ -z "$PAGE_TOKEN" ]; then
              break
            fi
            
            echo "ğŸ“„ æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—ä¸­..."
          done
          
          # å‰Šé™¤æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          if [ -f /tmp/deleted_count.txt ]; then
            TOTAL_DELETED=$(wc -l < /tmp/deleted_count.txt)
          fi
          
          echo ""
          echo "ğŸ‰ å®Œäº†ï¼å‰Šé™¤ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: $TOTAL_DELETED"
