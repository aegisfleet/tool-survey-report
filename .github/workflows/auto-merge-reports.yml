name: Auto Merge Reports only PRs

on:
  pull_request:
    types: [opened, synchronize, edited, ready_for_review, reopened]
    branches: [main]

permissions:
  contents: write
  actions: write
  pull-requests: write
  issues: write

jobs:
  auto-merge:
    name: Auto merge reports only PRs by google-labs-jules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Check and merge reports only PRs
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull_request payload available. Exiting.');
              return;
            }

            const prNumber = pr.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const author = pr.user && pr.user.login;

            core.info(`PR #${prNumber} by ${author}`);

            if (!author || !author.startsWith('google-labs-jules')) {
              core.info('PR author is not google-labs-jules — skipping.');
              return;
            }

            // Collect changed files (handle pagination)
            let files = [];
            let page = 1;
            while (true) {
              const res = await github.rest.pulls.listFiles({ owner, repo, pull_number: prNumber, per_page: 100, page });
              files = files.concat(res.data.map(f => f.filename));
              if (res.data.length < 100) break;
              page += 1;
            }

            if (files.length === 0) {
              core.info('No changed files found — skipping.');
              return;
            }

            core.info(`Changed files:\n${files.join('\n')}`);

            const allUnderReports = files.every(f => f.startsWith('_reports/'));
            if (!allUnderReports) {
              core.info('At least one changed file is outside _reports/ — skipping auto-merge.');
              return;
            }

            // PRがドラフトの場合、自動マージをスキップしてコメントを残す
            if (pr.draft) {
              core.info('PR is draft and only touches _reports/ — leaving a comment.');
              await github.rest.issues.createComment({ 
                owner, 
                repo, 
                issue_number: prNumber, 
                body: 'このドラフトPRは `_reports/` のみを変更しています。レビューの準備ができたら「Ready for review」に変更してください。その後、自動的にマージされます。\n\nThis draft PR only modifies `_reports/`. When you\'re ready for review, please mark it as "Ready for review". It will then be merged automatically.' 
              });
              core.notice('Skipping auto-merge for draft PR. Waiting for manual "Ready for review".');
              return;
            }

            // Merge the PR. Use 'squash' to keep main tidy; adjust if you prefer 'merge' or 'rebase'.
            core.info('Merging PR...');
            try {
              await github.rest.pulls.merge({ owner, repo, pull_number: prNumber, merge_method: 'squash' });
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: 'Auto-merged: changes limited to `_reports/`.' });
              core.info('PR merged successfully.');
              // Wait 10 seconds before triggering the jekyll workflow to give GitHub a moment to settle
              core.info('Waiting 10 seconds before dispatching jekyll.yml...');
              await new Promise(resolve => setTimeout(resolve, 10000));

              // Trigger jekyll.yml via workflow_dispatch on the default branch (main)
              try {
                core.info('Dispatching jekyll.yml workflow...');
                await github.rest.actions.createWorkflowDispatch({
                  owner,
                  repo,
                  workflow_id: 'jekyll.yml',
                  ref: 'main',
                  inputs: {}
                });
                core.info('jekyll.yml dispatched successfully.');
              } catch (dispatchErr) {
                core.warning(`Failed to dispatch jekyll.yml: ${dispatchErr}`);
              }
            } catch (err) {
              core.error(`Failed to merge PR: ${err}`);
              throw err;
            }
